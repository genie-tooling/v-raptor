{% extends "layout.html" %}
{% block title %}Dashboard{% endblock %}
{% block content %}
<h1>Dashboard</h1>

<div class="row">
    <div class="col-md-4">
        <a href="/" class="text-decoration-none">
            <div class="card text-white bg-primary mb-3">
                <div class="card-header">Total Repositories</div>
                <div class="card-body">
                    <h4 class="card-title">{{ metrics.total_repos }}</h4>
                </div>
            </div>
        </a>
    </div>
    <div class="col-md-4">
        <a href="/scans" class="text-decoration-none">
            <div class="card text-white bg-success mb-3">
                <div class="card-header">Total Scans</div>
                <div class="card-body">
                    <h4 class="card-title">{{ metrics.total_scans }}</h4>
                </div>
            </div>
        </a>
    </div>
    <div class="col-md-4">
        <a href="/findings" class="text-decoration-none">
            <div class="card text-white bg-danger mb-3">
                <div class="card-header">Total Findings</div>
                <div class="card-body">
                    <h4 class="card-title">{{ metrics.total_findings }}</h4>
                </div>
            </div>
        </a>
    </div>
<div class="card border-secondary mt-4">
    <div class="card-header">Recent Scans</div>
    <div class="card-body">
        {% with scans = recent_scans|sort(attribute='created_at', reverse=True) %}
            {% include '_scans_table.html' %}
        {% endwith %}
    </div>
</div>
<div class="row mt-4">
    <div class="col-md-4">
        <div class="card border-secondary">
            <div class="card-header">Findings by Severity</div>
            <div class="card-body">
                <canvas id="severityChart"></canvas>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card border-secondary">
            <div class="card-header">Findings by Repository</div>
            <div class="card-body">
                <canvas id="repoChart"></canvas>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card border-info">
            <div class="card-header">Code Quality Overview</div>
            <div class="card-body">
                <canvas id="qualityChart"></canvas>
            </div>
        </div>
    </div>
</div>

<script>
    console.log("Findings by Repo:", {{ findings_by_repo | tojson }});
</script>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const severityData = {
            labels: [{% for severity, count in findings_by_severity %}'{{ severity }}',{% endfor %}],
            datasets: [{
                label: 'Findings by Severity',
                data: [{% for severity, count in findings_by_severity %}{{ count }},{% endfor %}],
                backgroundColor: [
                    '#dc3545', // Red for CRITICAL
                    '#fd7e14', // Orange for HIGH
                    '#ffc107', // Yellow for MEDIUM
                    '#0dcaf0', // Cyan for LOW
                    '#6c757d'  // Grey for others
                ],
            }]
        };

        const repoData = {
            labels: [{% for repo, count in findings_by_repo %}'{{ repo }}',{% endfor %}],
            datasets: [{
                label: 'Findings by Repository',
                data: [{% for repo, count in findings_by_repo %}{{ count }},{% endfor %}],
                backgroundColor: '#0d6efd', // Blue
            }]
        };

        const qualityData = {
            labels: {{ quality_metrics.labels | tojson }},
            datasets: [
                {
                    label: 'Avg. Cyclomatic Complexity',
                    data: {{ quality_metrics.avg_complexity | tojson }},
                    backgroundColor: '#17a2b8', // Info Blue
                },
                {
                    label: 'Avg. Logical Lines of Code',
                    data: {{ quality_metrics.avg_lloc | tojson }},
                    backgroundColor: '#6f42c1', // Purple
                }
            ]
        };

        const severityChart = new Chart(document.getElementById('severityChart'), {
            type: 'pie',
            data: severityData,
        });

        const repoChart = new Chart(document.getElementById('repoChart'), {
            type: 'bar',
            data: repoData,
        });

        const qualityChart = new Chart(document.getElementById('qualityChart'), {
            type: 'bar',
            data: qualityData,
            options: {
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            }
        });
    });
</script>
{% endblock %}