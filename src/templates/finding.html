<!DOCTYPE html>
<html>
<head>
    <title>Finding #{{ finding.id }} - V-Raptor Dashboard</title>
    <link rel="stylesheet" href="/static/style.css">
</head>
<body>
    <h1>Finding #{{ finding.id }}</h1>
    <p><strong>Description:</strong> {{ finding.description }}</p>
    <p><strong>File:</strong> {{ finding.file_path }}</p>
    <p><strong>Line:</strong> {{ finding.line_number }}</p>
    <p><strong>Severity:</strong> {{ finding.severity }}</p>
    <p><strong>Confidence:</strong> {{ finding.confidence_score }}</p>
    <p><strong>Status:</strong> {{ finding.status }}</p>
    {% if finding.cve_id %}
        <p><strong>CVE:</strong> <a href="https://www.cve.org/CVERecord?id={{ finding.cve_id }}" target="_blank">{{ finding.cve_id }}</a></p>
    {% endif %}

    <form action="/recheck_finding/{{ finding.id }}" method="post" style="display: inline;">
        <button type="submit">Re-check Results</button>
    </form>
    <form action="/rewrite_remediation/{{ finding.id }}" method="post" style="display: inline;">
        <button type="submit">Re-write Remediation</button>
    </form>

    <h2>Code Snippet</h2>
    <pre><code>{{ finding.code_snippet }}</code></pre>

    {% if finding.patch %}
        <h2>Patch</h2>
        <form action="/update_patch/{{ finding.id }}" method="post">
            <textarea name="patch_diff" rows="10" cols="80">{{ finding.patch.generated_patch_diff }}</textarea>
            <button type="submit">Update Patch</button>
        </form>
    {% endif %}

    <h2>Evidence</h2>
    <ul>
        {% for evidence in finding.evidence %}
            <li>
                <h3>{{ evidence.type }}</h3>
                <pre><code>{{ evidence.content }}</code></pre>
            </li>
        {% endfor %}
    </ul>

    <h2>Chat with V-Raptor</h2>
    <div id="chat-history">
        {% for message in chat_history %}
            <p><strong>{{ message.sender }}:</strong> {{ message.message }}</p>
        {% endfor %}
    </div>
    <form id="chat-form">
        <input type="text" id="chat-input" placeholder="Ask a question about this finding...">
        <button type="submit">Send</button>
    </form>

    <script>
        const chatHistory = document.getElementById('chat-history');
        const chatForm = document.getElementById('chat-form');
        const chatInput = document.getElementById('chat-input');

        chatForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const message = chatInput.value;
            chatInput.value = '';

            const userMessage = document.createElement('p');
            userMessage.textContent = `You: ${message}`;
            chatHistory.appendChild(userMessage);

            const response = await fetch(`/chat/{{ finding.id }}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ message })
            });

            const data = await response.json();
            const botMessage = document.createElement('p');
            botMessage.textContent = `V-Raptor: ${data.response}`;
            chatHistory.appendChild(botMessage);
        });
    </script>
</body>
</html>