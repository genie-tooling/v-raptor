{% extends "layout.html" %}
{% block title %}Quality Interpretation{% endblock %}
{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1>Quality Interpretation for {{ metric.file_path }}</h1>
    <a href="/repository/{{ metric.scan.repository.id }}/quality" class="btn btn-secondary">Back to Quality Report</a>
</div>

<div class="row">
    <div class="col-md-6">
        <div class="card border-primary mb-3">
            <div class="card-header">Metrics</div>
            <div class="card-body">
                <p><strong>File Path:</strong> {{ metric.file_path }}</p>
                <p><strong>Cyclomatic Complexity:</strong> {{ metric.cyclomatic_complexity }}</p>
                <p><strong>Code Churn:</strong> {{ metric.code_churn }}</p>
                <p><strong>SLOC:</strong> {{ metric.sloc }}</p>
                <p><strong>LLOC:</strong> {{ metric.lloc }}</p>
                <p><strong>Comments:</strong> {{ metric.comments }}</p>
                <p><strong>Halstead Volume:</strong> {{ metric.halstead_volume }}</p>
            </div>
        </div>
    </div>
    <div class="col-md-6">
        <div class="card border-secondary mb-3">
            <div class="card-header">Interpretation</div>
            <div class="card-body">
                <div id="interpretation-text" style="white-space: pre-wrap; max-height: 200px; overflow-y: auto;">
                    {{ interpretation.interpretation }}
                </div>
            </div>
        </div>
    </div>
</div>

<div class="card border-info">
    <div class="card-header">
        Chat with V-Raptor
    </div>
    <div class="card-body">
        <div id="chat-history" class="mb-3" style="height: 300px; overflow-y: scroll; border: 1px solid #444; padding: 1rem; border-radius: 4px;">
            {% for message in chat_history %}
                <p><strong>{{ message.sender }}:</strong> {{ message.message }}</p>
            {% endfor %}
        </div>
        <form id="chat-form">
            <div class="input-group">
                <input type="text" id="chat-input" class="form-control" placeholder="Ask a question about this interpretation...">
                <button type="submit" class="btn btn-primary">Send</button>
                <button type="button" id="reset-chat-btn" class="btn btn-danger">Reset Chat</button>
            </div>
        </form>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const chatHistory = document.getElementById('chat-history');
        const chatForm = document.getElementById('chat-form');
        const chatInput = document.getElementById('chat-input');

        chatForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const message = chatInput.value;
            chatInput.value = '';

            const userMessage = document.createElement('p');
            userMessage.innerHTML = `<strong>You:</strong> ${message}`;
            chatHistory.appendChild(userMessage);
            chatHistory.scrollTop = chatHistory.scrollHeight;

            const response = await fetch(`/chat_with_quality_interpretation/{{ interpretation.id }}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ message })
            });

            const data = await response.json();
            const botMessage = document.createElement('p');
            botMessage.innerHTML = `<strong>V-Raptor:</strong> ${data.response}`;
            chatHistory.appendChild(botMessage);
            chatHistory.scrollTop = chatHistory.scrollHeight;
        });

        const resetChatBtn = document.getElementById('reset-chat-btn');

        resetChatBtn.addEventListener('click', async () => {
            if (confirm('Are you sure you want to reset the chat history?')) {
                const response = await fetch(`/reset_chat/quality/{{ interpretation.id }}`, {
                    method: 'POST'
                });

                const data = await response.json();
                if (data.status === 'success') {
                    chatHistory.innerHTML = '';
                    alert(data.message);
                } else {
                    alert(`Error: ${data.message}`);
                }
            }
        });
    });
</script>
{% endblock %}