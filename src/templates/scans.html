{% extends "layout.html" %}
{% block title %}All Scans{% endblock %}
{% block content %}
<h1>All Scans</h1>
<div class="card border-secondary">
    <div class="card-header">Scan History</div>
    <div class="card-body">
        <table class="table table-hover">
            <thead>
                <tr>
                    <th scope="col">Scan ID</th>
                    <th scope="col">Repository</th>
                    <th scope="col">Type</th>
                    <th scope="col">Status</th>
                    <th scope="col">Commit</th>
                    <th scope="col">Created At</th>
                    <th scope="col">Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for scan in scans %}
                <tr data-scan-id="{{ scan.id }}">
                    <td><a href="/scan/{{ scan.id }}">#{{ scan.id }}</a></td>
                    <td><a href="/repository/{{ scan.repository.id }}">{{ scan.repository.name }}</a></td>
                    <td>{{ scan.scan_type }}</td>
                    <td class="status-cell">
                        {% if scan.status.value == 'running' %}
                            <span class="badge bg-info">Running...</span>
                        {% elif scan.status.value == 'completed' %}
                            <span class="badge bg-success">Completed</span>
                        {% elif scan.status.value == 'queued' %}
                            <span class="badge bg-secondary">Queued</span>
                        {% elif scan.status.value == 'failed' %}
                            <span class="badge bg-danger">Failed</span>
                        {% else %}
                            <span class="badge bg-dark">{{ scan.status.value }}</span>
                        {% endif %}
                    </td>
                    <td>{{ scan.triggering_commit_hash[:7] if scan.triggering_commit_hash else 'N/A' }}</td>
                    <td>{{ scan.created_at.strftime('%Y-%m-%d %H:%M:%S') }}</td>
                    <td class="actions-cell">
                        <a href="/scan/{{ scan.id }}" class="btn btn-primary btn-sm">View</a>
                        {% if scan.status.value == 'running' %}
                            <form action="/stop_scan/{{ scan.id }}" method="post" style="display: inline;" class="ms-2">
                                <button type="submit" class="btn btn-warning btn-sm">Stop</button>
                            </form>
                        {% endif %}
                        <form action="/delete_scan/{{ scan.id }}" method="post" style="display: inline;" class="ms-2">
                            <button type="submit" class="btn btn-danger btn-sm">Delete</button>
                        </form>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const updateScanStatus = () => {
        fetch('/api/scans')
            .then(response => response.json())
            .then(scans => {
                scans.forEach(scan => {
                    const row = document.querySelector(`tr[data-scan-id='${scan.id}']`);
                    if (row) {
                        const statusCell = row.querySelector('.status-cell');
                        const actionsCell = row.querySelector('.actions-cell');
                        
                        let badgeClass = 'bg-dark';
                        if (scan.status === 'running') {
                            badgeClass = 'bg-info';
                        } else if (scan.status === 'completed') {
                            badgeClass = 'bg-success';
                        } else if (scan.status === 'queued') {
                            badgeClass = 'bg-secondary';
                        } else if (scan.status === 'failed') {
                            badgeClass = 'bg-danger';
                        }
                        
                        statusCell.innerHTML = `<span class="badge ${badgeClass}">${scan.status}</span>`;
                        
                        if (scan.status === 'running') {
                            actionsCell.innerHTML = `
                                <a href="/scan/${scan.id}" class="btn btn-primary btn-sm">View</a>
                                <form action="/stop_scan/${scan.id}" method="post" style="display: inline;" class="ms-2">
                                    <button type="submit" class="btn btn-warning btn-sm">Stop</button>
                                </form>
                                <form action="/delete_scan/${scan.id}" method="post" style="display: inline;" class="ms-2">
                                    <button type="submit" class="btn btn-danger btn-sm">Delete</button>
                                </form>
                            `;
                        } else {
                            actionsCell.innerHTML = `
                                <a href="/scan/${scan.id}" class="btn btn-primary btn-sm">View</a>
                                <form action="/delete_scan/${scan.id}" method="post" style="display: inline;" class="ms-2">
                                    <button type="submit" class="btn btn-danger btn-sm">Delete</button>
                                </form>
                            `;
                        }
                    }
                });
            });
    };

    setInterval(updateScanStatus, 5000);
});
</script>
{% endblock %}
