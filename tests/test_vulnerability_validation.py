import unittest
from unittest.mock import patch
import os

# Set a dummy API key for testing
os.environ['GEMINI_API_KEY'] = 'test-key'

from src.llm import LLMService
from src import config

class TestVulnerabilityValidation(unittest.TestCase):

    def setUp(self):
        with patch.object(config, 'SCANNER_LLM_PROVIDER', 'gemini'):
            self.llm_service = LLMService()

    @patch('src.llm.LLMService._create_chat_completion')
    def test_validate_vulnerability_false_positive(self, mock_create_chat_completion):
        """Test that validate_vulnerability correctly identifies a false positive."""
        mock_create_chat_completion.return_value = '{"false_positive": true}'
        result = self.llm_service.validate_vulnerability('some vulnerability', 'some search results')
        self.assertEqual(result, '{"false_positive": true}')

    @patch('src.llm.LLMService._create_chat_completion')
    def test_validate_vulnerability_not_false_positive(self, mock_create_chat_completion):
        """Test that validate_vulnerability correctly identifies a non-false positive."""
        mock_create_chat_completion.return_value = '{"false_positive": false}'
        result = self.llm_service.validate_vulnerability('some vulnerability', 'some search results')
        self.assertEqual(result, '{"false_positive": false}')

if __name__ == '__main__':
    unittest.main()
